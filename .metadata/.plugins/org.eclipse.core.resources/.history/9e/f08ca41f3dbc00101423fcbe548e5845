package test_gui_panelAdministrador;

import static org.junit.Assert.*;

import java.awt.Robot;
import java.util.ArrayList;
import java.util.HashMap;

import javax.swing.JButton;
import javax.swing.JCheckBox;
import javax.swing.JList;
import javax.swing.JRadioButton;
import javax.swing.JTextField;
import javax.swing.ListModel;

import org.junit.After;
import org.junit.Before;
import org.junit.Test;

import controlador.Controlador;
import modeloDatos.Administrador;
import modeloDatos.Auto;
import modeloDatos.Combi;
import modeloDatos.Moto;
import modeloDatos.Vehiculo;
import modeloNegocio.Empresa;
import util.Constantes;
import util.CreacionUtil;
import util.FalsoOptionPanel;
import util.IgualdadUtil;
import util.Mensajes;
import util.TestUtils;
import vista.Ventana;

public class Test_Gui_PanelAdmin_CrearVehiculo {

	private Ventana ventana;
	private Robot robot;
	private FalsoOptionPanel miOptionPanel;
	private Controlador controlador;
	private Empresa empresa;
	private Administrador admin;

	public void irAlPanelDelAdministrador() {
		JTextField campoNombreUsuario = (JTextField) TestUtils.getComponentForName(ventana, Constantes.NOMBRE_USUARIO);
		JTextField campoPassword = (JTextField) TestUtils.getComponentForName(ventana, Constantes.PASSWORD);
		JButton botonLogin = (JButton) TestUtils.getComponentForName(ventana, Constantes.LOGIN);

		TestUtils.clickComponent(campoNombreUsuario, robot);
		TestUtils.tipeaTexto(admin.getNombreUsuario(), robot);
		TestUtils.clickComponent(campoPassword, robot);
		TestUtils.tipeaTexto(admin.getPass(), robot);

		robot.delay(TestUtils.getDelay());
		TestUtils.clickComponent(botonLogin, robot);

	}

	@Before
	public void setUp() throws Exception {
		controlador = new Controlador();
		ventana = (Ventana) controlador.getVista();

		miOptionPanel = new FalsoOptionPanel();
		ventana.setOptionPane(miOptionPanel);

		admin = Administrador.getInstance();
		robot = new Robot();
		empresa = Empresa.getInstance();
		empresa.setUsuarioLogeado(admin);

		this.irAlPanelDelAdministrador();
	}

	@After
	public void tearDown() {
		empresa.setClientes(new HashMap<>());
		empresa.setPedidos(new HashMap<>());
		empresa.setVehiculos(new HashMap<>());
		empresa.setVehiculosDesocupados(new ArrayList<>());
		empresa.setChoferes(new HashMap<>());
		empresa.setChoferesDesocupados(new ArrayList<>());
		empresa.setViajesIniciados(new HashMap<>());
		empresa.setViajesTerminados(new ArrayList<>());
		empresa.setUsuarioLogeado(null);

		if (ventana != null) {
			ventana.dispose();
		}
	}

//	@Test
	public void test_panelAdministrador_botonNuevoVehiculo_habilitacionMoto() {
		JTextField campoPatente = (JTextField) TestUtils.getComponentForName(ventana, Constantes.PATENTE);
		JRadioButton radioMoto = (JRadioButton) TestUtils.getComponentForName(ventana, Constantes.MOTO);
		JButton botonAceptar = (JButton) TestUtils.getComponentForName(ventana, Constantes.NUEVO_VEHICULO);
		JCheckBox checkMascota = (JCheckBox) TestUtils.getComponentForName(ventana,
				Constantes.CHECK_VEHICULO_ACEPTA_MASCOTA);
		JTextField campoCantidadPlazas = (JTextField) TestUtils.getComponentForName(ventana,
				Constantes.CANTIDAD_PLAZAS);
		TestUtils.clickComponent(radioMoto, robot);
		robot.delay(TestUtils.getDelay());

		// Campo vacio, boton deshabilitado
		assertFalse(botonAceptar.isEnabled());

		// Con patente
		TestUtils.clickComponent(campoPatente, robot);
		TestUtils.tipeaTexto("A", robot);
		robot.delay(TestUtils.getDelay());
		assertFalse(checkMascota.isEnabled());
		assertFalse(campoCantidadPlazas.isEnabled());
		assertTrue(botonAceptar.isEnabled());
	}

//	@Test
	public void test_panelAdministrador_botonNuevoVehiculo_habilitacionAuto() {
		JTextField campoPatente = (JTextField) TestUtils.getComponentForName(ventana, Constantes.PATENTE);
		JButton botonAceptar = (JButton) TestUtils.getComponentForName(ventana, Constantes.NUEVO_VEHICULO);
		JCheckBox checkMascota = (JCheckBox) TestUtils.getComponentForName(ventana,
				Constantes.CHECK_VEHICULO_ACEPTA_MASCOTA);
		JTextField campoCantidadPlazas = (JTextField) TestUtils.getComponentForName(ventana,
				Constantes.CANTIDAD_PLAZAS);

		JRadioButton radioAuto = (JRadioButton) TestUtils.getComponentForName(ventana, Constantes.AUTO);

		TestUtils.clickComponent(radioAuto, robot);
		robot.delay(TestUtils.getDelay());

		// campos vacios, boton crear deshabilitado
		assertFalse(botonAceptar.isEnabled());
		assertTrue(checkMascota.isEnabled());
		assertTrue(campoCantidadPlazas.isEnabled());

		// Solo patente
		TestUtils.clickeaYEscribeTexto(campoPatente, "Auto", robot);
		robot.delay(TestUtils.getDelay());
		assertFalse(botonAceptar.isEnabled());
		TestUtils.borraJTextField(campoPatente, robot);

		// Solo cantidad de plazas
		TestUtils.clickeaYEscribeTexto(campoCantidadPlazas, "2", robot);
		robot.delay(TestUtils.getDelay());
		assertFalse(botonAceptar.isEnabled());
		TestUtils.borraJTextField(campoCantidadPlazas, robot);

		// cantidad de plazas fuera de rango (0)
		TestUtils.clickeaYEscribeTexto(campoPatente, "Auto", robot);
		TestUtils.clickeaYEscribeTexto(campoCantidadPlazas, "0", robot);
		robot.delay(TestUtils.getDelay());
		assertFalse(
				"El boton no se deshabilito cuando se ingreso 0 plazas para el auto",
				botonAceptar.isEnabled());
		TestUtils.borraJTextField(campoCantidadPlazas, robot);

		// cantidad de plazas fuera de rango (5)
		TestUtils.clickeaYEscribeTexto(campoCantidadPlazas, "5", robot);
		robot.delay(TestUtils.getDelay());
		assertFalse(botonAceptar.isEnabled());
		TestUtils.borraJTextField(campoCantidadPlazas, robot);

		// Con patente y cantidad de plazas en rango
		TestUtils.clickeaYEscribeTexto(campoCantidadPlazas, "2", robot);
		robot.delay(TestUtils.getDelay());
		assertTrue(botonAceptar.isEnabled());

		// pantene, plazas y mascota
		TestUtils.clickComponent(checkMascota, robot);
		robot.delay(TestUtils.getDelay());
		assertTrue(botonAceptar.isEnabled());
	}

//	@Test
	public void test_panelAdministrador_botonNuevoVehiculo_habilitacionCombi() {
		JTextField campoPatente = (JTextField) TestUtils.getComponentForName(ventana, Constantes.PATENTE);
		JButton botonAceptar = (JButton) TestUtils.getComponentForName(ventana, Constantes.NUEVO_VEHICULO);
		JCheckBox checkMascota = (JCheckBox) TestUtils.getComponentForName(ventana,
				Constantes.CHECK_VEHICULO_ACEPTA_MASCOTA);
		JTextField campoCantidadPlazas = (JTextField) TestUtils.getComponentForName(ventana,
				Constantes.CANTIDAD_PLAZAS);

		JRadioButton radioCombi = (JRadioButton) TestUtils.getComponentForName(ventana, Constantes.COMBI);

		TestUtils.clickComponent(radioCombi, robot);
		robot.delay(TestUtils.getDelay());

		// campos vacios, boton crear deshabilitado
		assertFalse(botonAceptar.isEnabled());
		assertTrue(checkMascota.isEnabled());
		assertTrue(campoCantidadPlazas.isEnabled());

		// Solo patente
		TestUtils.clickeaYEscribeTexto(campoPatente, "Combi", robot);
		robot.delay(TestUtils.getDelay());
		assertFalse(botonAceptar.isEnabled());
		TestUtils.borraJTextField(campoPatente, robot);

		// Solo cantidad de plazas
		TestUtils.clickeaYEscribeTexto(campoCantidadPlazas, "8", robot);
		robot.delay(TestUtils.getDelay());
		assertFalse(botonAceptar.isEnabled());
		TestUtils.borraJTextField(campoCantidadPlazas, robot);

		// cantidad de plazas fuera de rango (0)
		TestUtils.clickeaYEscribeTexto(campoPatente, "Combi", robot);
		TestUtils.clickeaYEscribeTexto(campoCantidadPlazas, "0", robot);
		robot.delay(TestUtils.getDelay());
		assertFalse(botonAceptar.isEnabled());
		TestUtils.borraJTextField(campoCantidadPlazas, robot);

		// cantidad de plazas fuera de rango (4)
		TestUtils.clickeaYEscribeTexto(campoCantidadPlazas, "4", robot);
		robot.delay(TestUtils.getDelay());
		assertFalse(botonAceptar.isEnabled());
		TestUtils.borraJTextField(campoCantidadPlazas, robot);

		// cantidad de plazas fuera de rango (11)
		TestUtils.clickeaYEscribeTexto(campoCantidadPlazas, "11", robot);
		robot.delay(TestUtils.getDelay());
		assertFalse(botonAceptar.isEnabled());
		TestUtils.borraJTextField(campoCantidadPlazas, robot);

		// Con patente y cantidad de plazas en rango
		TestUtils.clickeaYEscribeTexto(campoCantidadPlazas, "8", robot);
		robot.delay(TestUtils.getDelay());
		assertTrue(botonAceptar.isEnabled());

		// pantene, plazas y mascota
		TestUtils.clickComponent(checkMascota, robot);
		robot.delay(TestUtils.getDelay());
		assertTrue(botonAceptar.isEnabled());
	}

	@Test
	public void test_panelAdministrador_crearMoto_debenEstarAgregadosEnLaLista() {
		
		JList<Vehiculo> listaVehiculos = (JList<Vehiculo>) TestUtils.getComponentForName(ventana,
				Constantes.LISTA_VEHICULOS_TOTALES);

		Moto motoCreada = new Moto("MM123MM");
		CreacionUtil.crearVehiculoPanel(ventana, robot, CreacionUtil.MOTO, motoCreada);
		Vehiculo motoEnLaLista = listaVehiculos.getModel().getElementAt(0);
		assertTrue(IgualdadUtil.sonIguales(motoEnLaLista, motoCreada));
	}

	@Test
	public void test_panelAdministrador_crearAuto_debenEstarAgregadosEnLaLista() {

		JList<Vehiculo> listaVehiculos = (JList<Vehiculo>) TestUtils.getComponentForName(ventana,
				Constantes.LISTA_VEHICULOS_TOTALES);

		Auto autoMascota = new Auto("mascotaA", 4, true);
		Auto autoSinMascota = new Auto("NOmascotaA", 4, false);

		CreacionUtil.crearVehiculoPanel(ventana, robot, CreacionUtil.AUTO, autoMascota);
		CreacionUtil.crearVehiculoPanel(ventana, robot, CreacionUtil.AUTO, autoSinMascota);

		// Verificar que los vehiculos estan en la lista
		ListModel<Vehiculo> listaVehiculosPanelAdmin = (ListModel<Vehiculo>) listaVehiculos.getModel();
		assertEquals("La lista de vehiculos del panel no contiene dos elementos", 2,
				listaVehiculosPanelAdmin.getSize());

		for (int i = 0; i < listaVehiculosPanelAdmin.getSize(); i++) {
			Vehiculo vehiculo = listaVehiculosPanelAdmin.getElementAt(i);
			if (vehiculo.getPatente().equals(autoMascota.getPatente())) {
				assertTrue(IgualdadUtil.sonIguales(autoMascota, vehiculo));
			} else if (vehiculo.getPatente().equals(autoSinMascota.getPatente())) {
				assertTrue(IgualdadUtil.sonIguales(autoSinMascota, vehiculo));
			}
		}
	}

//	@Test
	public void test_panelAdministrador_crearCombi_debenEstarAgregadosEnLaLista() {

		JList<Vehiculo> listaVehiculos = (JList<Vehiculo>) TestUtils.getComponentForName(ventana,
				Constantes.LISTA_VEHICULOS_TOTALES);

		Combi combiMascota = new Combi("mascotaC", 8, true);
		Combi combiSinMascota = new Combi("NOmascotaC", 8, false);

		ListModel<Vehiculo> listaVehiculosPanelAdmin = (ListModel<Vehiculo>) listaVehiculos.getModel();
		assertEquals("La lista de vehiculos del panel no contiene dos elementos", 2,
				listaVehiculosPanelAdmin.getSize());

		for (int i = 0; i < listaVehiculosPanelAdmin.getSize(); i++) {
			Vehiculo vehiculo = listaVehiculosPanelAdmin.getElementAt(i);
			if (vehiculo.getPatente().equals(combiMascota.getPatente())) {
				assertTrue(IgualdadUtil.sonIguales(combiMascota, vehiculo));
			} else if (vehiculo.getPatente().equals(combiSinMascota.getPatente())) {
				assertTrue(IgualdadUtil.sonIguales(combiSinMascota, vehiculo));
			}
		}
	}

	@Test
	public void test_panelAdmin_crearAutoCon0Plazas_debeMostrarMensajeError() {
		JTextField campoPatente = (JTextField) TestUtils.getComponentForName(ventana, Constantes.PATENTE);
		JTextField campoCantidadPlazas = (JTextField) TestUtils.getComponentForName(ventana,
				Constantes.CANTIDAD_PLAZAS);
		JRadioButton radioAuto = (JRadioButton) TestUtils.getComponentForName(ventana, Constantes.AUTO);
		JButton botonAceptar = (JButton) TestUtils.getComponentForName(ventana, Constantes.NUEVO_VEHICULO);

		miOptionPanel.setMensaje(null);
		TestUtils.clickComponent(radioAuto, robot);
		TestUtils.clickeaYEscribeTexto(campoPatente, "Auto0Plazas", robot);
		TestUtils.clickeaYEscribeTexto(campoCantidadPlazas, "0", robot);
		robot.delay(TestUtils.getDelay());
		TestUtils.clickComponent(botonAceptar, robot);
		robot.delay(TestUtils.getDelay());

		assertEquals("El option panel no ejecuto el mensaje correspondiente al intentar crear auto con 0 plazas",
				Mensajes.VEHICULO_NO_VALIDO.getValor(), miOptionPanel.getMensaje());
	}


//	@Test
	public void test_panelAdministrador_crearVehiculoConPatenteRepetida_debeMostrarMensajeError() {
		String patenteRepetida = "patenteRepetida";

		JList<Vehiculo> listaVehiculos = (JList<Vehiculo>) TestUtils.getComponentForName(ventana,
				Constantes.LISTA_VEHICULOS_TOTALES);
		JTextField campoPatente = (JTextField) TestUtils.getComponentForName(ventana, Constantes.PATENTE);
		JTextField campoCantidadPlazas = (JTextField) TestUtils.getComponentForName(ventana,
				Constantes.CANTIDAD_PLAZAS);
		JRadioButton radioMoto = (JRadioButton) TestUtils.getComponentForName(ventana, Constantes.MOTO);
		JRadioButton radioAuto = (JRadioButton) TestUtils.getComponentForName(ventana, Constantes.AUTO);
		JRadioButton radioCombi = (JRadioButton) TestUtils.getComponentForName(ventana, Constantes.COMBI);
		JButton botonAceptar = (JButton) TestUtils.getComponentForName(ventana, Constantes.NUEVO_VEHICULO);

		// Vehiculo inicial
		TestUtils.clickComponent(radioMoto, robot);
		TestUtils.clickeaYEscribeTexto(campoPatente, patenteRepetida, robot);
		robot.delay(TestUtils.getDelay());
		TestUtils.clickComponent(botonAceptar, robot);

		// Crear moto con patente repetida
		miOptionPanel.setMensaje(null);
		TestUtils.clickComponent(radioMoto, robot);
		robot.delay(TestUtils.getDelay());
		TestUtils.clickComponent(botonAceptar, robot);
		robot.delay(TestUtils.getDelay());

		// Ver si lanza el mensaje
		assertEquals("El option panel no ejecuto el mensaje correspondiente al intentar crear moto repetida",
				Mensajes.VEHICULO_YA_REGISTRADO.getValor(), miOptionPanel.getMensaje());

		// Crear auto con patente repetida
		miOptionPanel.setMensaje(null);
		TestUtils.clickComponent(radioAuto, robot);
		robot.delay(TestUtils.getDelay());
		TestUtils.clickeaYEscribeTexto(campoCantidadPlazas, "2", robot);
		robot.delay(TestUtils.getDelay());
		TestUtils.clickComponent(botonAceptar, robot);
		robot.delay(TestUtils.getDelay());

		assertEquals("El option panel no ejecuto el mensaje correspondiente al intentar crear auto repetido",
				Mensajes.VEHICULO_YA_REGISTRADO.getValor(), miOptionPanel.getMensaje());

		TestUtils.borraJTextField(campoCantidadPlazas, robot);

		// Crear combi con patente repetida
		miOptionPanel.setMensaje(null);
		TestUtils.clickComponent(radioCombi, robot);
		TestUtils.clickeaYEscribeTexto(campoCantidadPlazas, "6", robot);
		robot.delay(TestUtils.getDelay());
		TestUtils.clickComponent(botonAceptar, robot);
		robot.delay(TestUtils.getDelay());

		assertEquals("El option panel no ejecuto el mensaje correspondiente al intentar crear combi repetida",
				Mensajes.VEHICULO_YA_REGISTRADO.getValor(), miOptionPanel.getMensaje());

		// Ver si solo esta la moto
		ListModel<Vehiculo> modeloListaVehiculos = listaVehiculos.getModel();
		assertEquals("La lista de vehiculos del panel no contiene un solo elemento", 1, modeloListaVehiculos.getSize());
		Vehiculo vehiculoEnLista = modeloListaVehiculos.getElementAt(0);
		assertTrue("El vehiculo en la lista no es una moto", vehiculoEnLista instanceof Moto);
		assertEquals("La patente no corresponde", patenteRepetida, vehiculoEnLista.getPatente());
	}

}
